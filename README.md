# Streamwater Project ‚Äî DISCO

**DISCO (DIstributional Subgroup Clustering for Online Imputation)** is a fast and scalable framework for **batch time-series imputation** of water consumption data.

The method leverages **frequency-distribution clustering of behavioural subgroups** across **hourly, daily, weekly and monthly patterns**.

---

# üì¶ Project Structure

```text
.
‚îú‚îÄ‚îÄ src
‚îÇ   ‚îú‚îÄ‚îÄ data_analysis.ipynb      # Clustering + statistics warm-up (run once)
‚îÇ   ‚îî‚îÄ‚îÄ impute_ts.py             # Batch imputation pipeline
‚îÇ
‚îú‚îÄ‚îÄ Data
‚îÇ   ‚îú‚îÄ‚îÄ Contadores.xlsx          # Static input
‚îÇ   ‚îú‚îÄ‚îÄ TelemetriaConsumosVilaSol_v2.csv  # Static input
‚îÇ   ‚îî‚îÄ‚îÄ inputs_ts.csv            # ‚öôÔ∏è Generated by notebook
‚îÇ
‚îú‚îÄ‚îÄ variables
‚îÇ   ‚îî‚îÄ‚îÄ variables.pkl            # ‚öôÔ∏è Generated by notebook
‚îÇ
‚îî‚îÄ‚îÄ README.md
```

---

# 1Ô∏è‚É£ Clustering & Warm-Up ‚Äî `src/data_analysis.ipynb`

This notebook prepares the historical dataset and builds the **distributional subgroup clusters** used during imputation. Its output (`variables.pkl`) defines the group/subgroup structure that `impute_ts.py` loads at startup. It only needs to be re-run if consumption patterns change significantly.

> **Note on statistics warm-up:** `impute_ts.py` initialises all statistics from scratch and updates them as it processes each record ‚Äî this is the warm-up phase. If you want to adapt the script for **true online (stream) imputation**, `impute_ts.py` should first be run in warm-up mode (`skip=True`) on historical data to build up the statistics before serving live imputation requests.

## Input Datasets

### `Contadores.xlsx`
Metadata for each **Point of Consumption (LC)**:
- `contact_id`
- `tipo_consumo` (Type of Consumption)

### `TelemetriaConsumosVilaSol_v2.csv`
Hourly cumulative meter readings:

| Column | Description |
|---|---|
| id | Meter ID |
| contact_id | Point of Consumption ID |
| calibre | Nominal diameter (mm) |
| data_instalacao | Installation date |
| data | Day of consumption |
| index_0 ‚Äì index_23 | Hourly cumulative values |

---

## üîÑ Data Transformation

Daily cumulative readings are converted into an **hourly time-series dataset**:

`seq_all_df` ‚Üí exported as `inputs_ts.csv`

### Final Schema (1 row per hour)

**Metadata:** `id`, `contact_id`, `calibre`, `data_instalacao`, `tipo_consumo`

**Time features:** `hour`, `month`, `month_name`, `day_of_week`, `day_name`

**Consumption:** `cumulative_value`, `consumption` (hourly usage)

---

## üß† Clustering Strategy

Clustering is performed using a **two-level hierarchical grouping**.

### Group Level
`(tipo_consumo, calibre)` ‚Äî e.g., ("Dom√©stico", 15)

### Subgroup Level
`(month, day_of_week, hour)` ‚Äî a specific temporal context within a group.

### Data Structure

The clustering output is a **list of lists**. Each index corresponds to one group and contains a list of dictionaries ‚Äî one per subgroup. Each dictionary has the following keys:

```python
{
    "months":  [...],   # list of months this subgroup covers
    "days":    [...],   # list of weekdays this subgroup covers
    "hours":   [...],   # list of hours this subgroup covers
    "df":      ...      # DataFrame of all observations matching this subgroup
}
```

### Stored Artefacts

Saved to `variables/variables.pkl`. This file is loaded once by `impute_ts.py` and is not modified during imputation.

Contents:
- List of subgroup dictionaries (as described above)
- `idx2pair` ‚Üí index ‚Üí `(tipo_consumo, calibre)`
- `pair2idx` ‚Üí `(tipo_consumo, calibre)` ‚Üí index

---

# 2Ô∏è‚É£ Imputation ‚Äî `src/impute_ts.py`

This script performs **batch imputation** over the full `inputs_ts.csv` dataset, processing records sequentially. Optionally, it also applies applies range corrections upon True value and rebuilds cumulative values.

## ‚öôÔ∏è Script Parameters

| Parameter | Description | Default |
|---|---|---|
| `data` | Path to `variables.pkl` warm-up file | required |
| `input_csv` | Path to hourly time-series file | required |
| `weight_contact` | Weight given to the LC's own history when blending with subgroup data at Level 1. `(1 - weight_contact)` is the subgroup's weight. | 0.7 |
| `ewma_alpha` | EWMA decay factor Œ± | 0.1 |
| `skip` | If `True`, only updates statistics without imputing or post-processing | `False` |

**The script performs the following steps:**
1. Iterates through the dataset, imputing missing values and updating warm-up statistics.
2. Applies range corrections upon True value (optional, skipped if `skip=True`).
3. Rebuilds cumulative values (optional, skipped if `skip=True`).

---

## üîÑ Belief Update Logic

Two beliefs are maintained and updated at each time step `t`:

### 1. LC (Point of Consumption) Belief

```
Œº(t)_LC = (1 - Œ±) ¬∑ Œº(t-1)_LC + Œ± ¬∑ x(t)_LC
```

- `x(t)_LC`: true hourly consumption of the LC at time `t`
- `Œ±` (`ewma_alpha`): controls how fast the belief adapts to new observations
- Each LC maintains a **separate belief per subgroup** it appears in.

### 2. Subgroup Belief

```
Œº(t)_subgroup = (1 - Œ±) ¬∑ Œº(t-1)_subgroup + Œ± ¬∑ xÃÑ(t)_subgroup
```

- `xÃÑ(t)_subgroup`: mean consumption across all LCs in that subgroup at time `t`

### Initialisation

All belief values (`pop_mean`, `ewma_mean`, `ewma_var`, `ewma_std`) are initialised to **0**. `count` is initialised to **1** to avoid division-by-zero on the first update.

---

## üîÅ Imputation Fallback Strategy

DISCO uses a **4-level hierarchical fallback** to guarantee robustness. Each imputed value is tagged with the level used, enabling full traceability.

### Warm-Up Data Structures (updated during imputation)

| Structure | Key | Description |
|---|---|---|
| `subgroup_stats` | `(pair_idx, subgroup_idx)` | Statistics for a subgroup within a group |
| `contact_stats` | `(contact_id, pair_idx, subgroup_idx)` | Statistics for a specific LC in a specific subgroup |
| `contact_pair_stats` | `(contact_id, pair_idx)` | Statistics for a specific LC across all subgroups |
| `pair_stats` | `pair_idx` | Global statistics for a group across all subgroups |

Each structure stores: `pop_mean`, `pop_var`, `ewma_mean`, `ewma_var`, `ewma_std`, `count`.

### Imputation Levels

| Level | Name | Description |
|---|---|---|
| **1 (Default)** | `contact_subgroup` | Blends the LC's own subgroup history with the subgroup's general distribution, weighted by `weight_contact` and `(1 - weight_contact)` respectively. |
| **2** | `only_subgroup` | Uses the subgroup distribution for the group `(tipo_consumo, calibre)`, ignoring LC history entirely. Used when the LC has no history for this subgroup. |
| **3** | `only_contact` | Uses the LC's historical behaviour across **all subgroups**. Used when no subgroup data is available. |
| **4** | `only_group` | Uses the global distribution for the group `(tipo_consumo, calibre)`. Most generic fallback. |

> **Note on unseen LCs:** A `contact_id` not present in the warm-up data will naturally have no `contact_stats`, so Level 1 fails and imputation falls through to Level 2 or beyond automatically.

If no level produces a value, the consumption is left **missing**.

---

# üìä Best Hyperparameters per Group

Only groups with validated weights are shown.

| Type of Consumption | Calibre | weight_contact | ewma_alpha |
|---|---|---|---|
| Rega Inframoura | 40 | 0.1 | 0.1 |
| Com√©rcio | 15 | 0.9 | 0.9 |
| Dom√©stico | 15 | 0.9 | 0.9 |
| Servi√ßos-Condom√≠nio | 15 | 0.3 | 0.3 |
| Ind√∫stria | 15 | 0.7 | 0.9 |
| Servi√ßos-Condom√≠nio | 20 | 0.7 | 0.5 |
| Ind√∫stria | 50 | 0.5 | 0.9 |
| Ind√∫stria | 40 | 0.9 | 0.9 |
| Ind√∫stria | 20 | 0.7 | 0.7 |
| Com√©rcio | 40 | 0.1 | 0.1 |
| Rega Inframoura | 15 | 0.1 | 0.1 |
| Servi√ßos 2¬∫ Contador ‚Äì Rega Condom√≠nio | 50 | 0.7 | 0.9 |
| Ind√∫stria sem RSU | 80 | 0.1 | 0.7 |
| Servi√ßos-Condom√≠nio | 65 | 0.7 | 0.3 |
| Servi√ßos-Condom√≠nio | 100 | 0.9 | 0.7 |
| Rega-Dom√©stico | 20 | 0.9 | 0.3 |
| Dom√©stico | 20 | 0.9 | 0.9 |
| N√£o Dom√©stico ‚Äì Rega | 20 | 0.9 | 0.7 |
| Rega-Dom√©stico | 15 | 0.1 | 0.1 |
| Rega Inframoura | 30 | 0.1 | 0.3 |
| Ind√∫stria | 30 | 0.3 | 0.9 |
| Institui√ß√µes de Utilidade P√∫blica | 15 | 0.1 | 0.1 |
| Rega Inframoura | 20 | 0.1 | 0.5 |
| Servi√ßos 2¬∫ Contador ‚Äì Rega Condom√≠nio | 80 | 0.1 | 0.3 |
| Servi√ßos 2¬∫ Contador ‚Äì Rega Condom√≠nio | 40 | 0.1 | 0.3 |
| Ind√∫stria | 25 | 0.1 | 0.1 |
| Ind√∫stria Inframoura | 15 | 0.1 | 0.5 |
| Obras | 15 | 0.1 | 0.1 |
| Servi√ßos-Condom√≠nio | 80 | 0.1 | 0.9 |
| Obras | 20 | 0.1 | 0.7 |

---

# üöÄ Summary

DISCO enables:
- **Behaviour-aware clustering** for precise temporal profiling.
- **Batch imputation** with adaptive statistics that update as the dataset is processed.
- **Robust fallback** across 4 specificity levels to handle any LC, including unseen ones.
- **EWMA corrections** to follow consumption pattern shifts over time.
- **Full traceability** ‚Äî every imputed value is tagged with the level used.

DISCO enables:
- **Behaviour-aware clustering** for precise profiling.
- **Real-time imputation** for continuous data streams.
- **Adaptive EWMA corrections** to follow consumption shifts.
- **Scalable deployment for smart-meter time series.**
